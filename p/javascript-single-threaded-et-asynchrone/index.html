<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="alternate" type="application/rss+xml" title="Thomas Belin's Blog" href="https://blog.atomrc.dev/feed.xml"><link rel="icon" href="/favicon.ico"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><title>Javascript : Single-threaded et asynchrone - Thomas Belin</title><meta name="description" content="Comment Javascript fait pour √™tre √† la fois single-threaded et asynchrone."><meta name="author" content="Thomas Belin"><link rel="canonical" href="https://blog.atomrc.dev/p/javascript-single-threaded-et-asynchrone/"><meta property="og:title" content="Javascript : Single-threaded et asynchrone - Thomas Belin"><meta property="og:description" content="Comment Javascript fait pour √™tre √† la fois single-threaded et asynchrone."><meta property="og:url" content="https://blog.atomrc.dev/p/javascript-single-threaded-et-asynchrone/"><meta property="og:image" content="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@atomrc"><meta name="twitter:title" content="Javascript : Single-threaded et asynchrone - Thomas Belin"><meta name="twitter:description" content="Comment Javascript fait pour √™tre √† la fois single-threaded et asynchrone."><meta name="twitter:image" content="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc"><meta name="color-scheme" content="dark light"><style>body{--ff-sans:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Ubuntu","Roboto","Noto Sans","Droid Sans",sans-serif;--ff-mono:ui-monospace,"Cascadia Mono","Segoe UI Mono","Ubuntu Mono","Roboto Mono",Menlo,Monaco,Consolas,monospace;padding:0;margin:0;color:var(--font-color);background-color:var(--bg-color);font-family:var(--ff-sans);font-size:13pt}body,body.light-mode{--font-color:#333;--font-secondary-color:#555;--bg-color:#fff;--title-color:#e7005d;--link-color:#0e4db5;--bg-code-color:#f6f6f6;--secondary-color:#eee}body.dark-mode{--font-color:#ddd;--font-secondary-color:#aaa;--bg-color:#1c1c21;--title-color:var(--link-color);--link-color:rgb(88, 166, 255);--bg-code-color:#444;--secondary-color:#333}#dark-mode-toggle{border:none;background-color:transparent;position:fixed;top:1em;right:1em;z-index:1;height:24px;width:24px;overflow:hidden}#dark-mode-toggle svg{stroke:var(--font-color);fill:var(--font-color);transition:opacity .3s,fill .3s,stroke .3s;position:absolute;top:0;left:0}.dark-mode #dark-mode-toggle .moon,.light-mode #dark-mode-toggle .sun{opacity:0}a{text-decoration:none;color:var(--link-color)}ul{list-style:none;padding:0}.avatar{height:100px;width:100px;border-radius:50px}.title{color:var(--title-color)}.title a{color:inherit}.list-title{font-size:1.2em;font-weight:400;margin:.1em}aside{padding-left:.5em;font-size:.8em}#header{text-align:center;font-size:1.95em;padding:1em}#header nav{text-align:center;margin-top:.6em;font-size:.5em}#header .title{color:var(--font-color);font-weight:200}footer{text-align:center;padding:2em}.love{color:red}footer a{color:inherit;text-decoration:underline}.list-container{max-width:50%;margin:auto;text-align:center}@media screen and (max-width:1000px){.list-container{max-width:75%}}@media screen and (max-width:650px){.list-container{max-width:80%}}.list-container__title{text-align:center}.list-container__list li{padding-bottom:.5em}.list-container__headline{max-width:500px}.list-container__content{display:inline-block;text-align:left}</style><script async defer="defer" data-domain="atomrc.dev" src="https://plausible.io/js/plausible.js"></script></head><body><button id="dark-mode-toggle" aria-label="Toggle bewteen dark and light mode"><svg xmlns="http://www.w3.org/2000/svg" class="sun" stroke-linejoin="round" stroke-linecap="round" stroke-width="2" stroke="#000" fill="none" height="24" width="24"><circle r="5" cy="12" cx="12"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" class="moon"><path style="stroke-width:.0469517" d="M13.278 24.02c3.707 0 7.093-1.687 9.336-4.451a.564.564 0 0 0-.543-.909c-5.831 1.111-11.186-3.36-11.186-9.247a9.41 9.41 0 0 1 4.765-8.188.564.564 0 0 0-.176-1.044 12.12 12.12 0 0 0-2.196-.2C6.643-.02 1.258 5.356 1.258 12c0 6.635 5.376 12.02 12.02 12.02z"/></svg></button><script>(function (win, doc) {
  let isDarkMode =
    sessionStorage.getItem("darkmode") === undefined
      ? win.matchMedia("(prefers-color-scheme: dark)").matches
      : sessionStorage.getItem("darkmode") === "true";

  const toggleDarkMode = (setDarkMode) => {
    isDarkMode = setDarkMode ?? !isDarkMode;
    sessionStorage.setItem("darkmode", isDarkMode);
    if (isDarkMode) {
      document.body.classList.add("dark-mode");
      document.body.classList.remove("light-mode");
    } else {
      document.body.classList.remove("dark-mode");
      document.body.classList.add("light-mode");
    }
  };

  toggleDarkMode(isDarkMode);
  const darkModeToggle = doc.getElementById("dark-mode-toggle");

  darkModeToggle.addEventListener("click", () => toggleDarkMode());
})(window, document);</script><section id="header"><div><a href="/"><img class="avatar" src="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=200" alt="Avatar"></a><br><a class="title" href="/"><span rel="author">Thomas Belin</span></a><br></div><nav><a href="/about/">About Me</a></nav></section><section><link href="/css/article.css" rel="stylesheet" async defer="defer"><link href="/css/syntax.css" rel="stylesheet" async defer="defer"><style>article{max-width:800px;margin:auto;padding:0 1em;position:relative;line-height:1.5em}article h1{font-size:2em;font-weight:300;line-height:1em}article h2,article h3{position:relative;padding-bottom:.3em;font-weight:500;line-height:1.2em}article h2{font-size:2em;border-bottom:solid 1px var(--secondary-color);margin:1em 0 .5em}article h3{font-size:1.5em;margin:1em 1em}article ul{list-style-type:disc;padding:0 2em}article picture{border:solid 1px grey;display:block;max-width:100%;margin:auto}picture img,video{width:100%;height:auto}</style><article lang="fr"><header><h1 class="title">Javascript : Single-threaded et asynchrone</h1><aside>üè∑Ô∏è <span class="tag">posts</span>&nbsp; <span class="tag">JavaScript</span>&nbsp; <span class="tag">Internals</span>&nbsp;<br><time datetime="" pubdate itemprop="datePublished" content="">üìÜ 01&nbsp;Jun&nbsp;13</time></aside></header><div class="article-body"><p>Javascript est single-threaded, c'est quelque chose qui est rentr√© dans la t√™te de la plupart des d√©veloppeurs front-end. Cependant ce √† quoi on ne r√©fl√©chit pas assez c'est : comment est-il possible d'√™tre √† la fois single-threaded et de g√©rer du code asynchrone.</p><h2 id="les-cons%C3%A9quences-du-thread-unique" tabindex="-1">Les cons√©quences du thread unique</h2><p>Bon c'est bien beau de savoir que Javascript ne dispose que d'un seul thread mais commen√ßons par voir ce que √ßa implique ?</p><p>Les bons c√¥t√©s :</p><ul><li>jamais d'acc√®s concurrents aux donn√©es ;</li><li>Le debuggage est nettement simplifi√©.</li></ul><p>Les mauvais c√¥t√©s :</p><ul><li>Vous pouvez bloquer votre application avec du code un peu trop gourmand ;</li><li>On ne peut pas faire confiance aux timers (setTimeout et setInterval) qui ont une pr√©cision approximative.</li></ul><p>Pour se convaincre √† la fois des bons et des mauvais c√¥t√©s voici un petit bout de code qui va l'illustrer. Consid√©rez le code suivant :</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">"start"</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">=</span> <span class="token string">"done"</span><span class="token punctuation">;</span>
    <span class="token function">importantThingToDo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// -> "done"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">timeConsumingFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// -> "start"</span></code></pre><p>Dans ce code, je suis s√ªr et certain que ma console affichera &quot;start&quot; en premier m√™me si l'ex√©cution de timeConsumingFunction() prend bien plus de 100ms. Si setTimeout avait cr√©√© un nouveau thread, je n'aurais pas pu pr√©dire si ma console allait afficher &quot;start&quot; puis &quot;done&quot; ou le contraire. Autre chose √† prendre en compte, si l'ex√©cution de timeConsumingFunction prend plus que 100ms, importantThingToDo sera retard√©e. Si vous ajoutez √† √ßa des interactions utilisateurs, vous pourrez encore retarder un peu son ex√©cution.</p><h2 id="les-timers" tabindex="-1">Les timers</h2><p>Les timers (setTimeout et setInterval) sont nos outils pour faire du code asynchrone avec Javascript. On se donnerait presque l'impression qu'on cr√©√© des threads et pourtant ... En r√©alit√© il ne faut pas voir les timers comme des fonctions asynchrones mais plut√¥t comme des gestionnaires de queue. Et oui, la fonction principale des timers est d'empiler des fonctions qui seront ex√©cut√©es s√©quentiellement et au plus t√¥t n millisecondes plus tard. Le param√®tre de temps prend alors une signification un peu diff√©rente de celle √† laquelle on pourrait penser. Au lieu de :</p><ul><li>&quot;Ex√©cute cette fonction dans n millisecondes&quot;</li></ul><p>il faut plut√¥t avoir en t√™te :</p><ul><li>&quot;D√®s que tu es dispo apr√®s n millisecondes, ex√©cute cette fonction&quot;</li></ul><p>D'o√π la faible fiabilit√© des timers Javascript.</p><p>Pour une explication un peu plus compl√®te sur le fonctionnement des timers de Javascript, je vous invite √† lire l'article <a href="http://ejohn.org/blog/how-javascript-timers-work/">How JavaScript Timers Work</a> de John Resig dont je me suis beaucoup inspir√© pour mon article.</p><h2 id="les-%C3%A9v%C3%A9nements%2C-le-secret-des-op%C3%A9rations-asynchrones" tabindex="-1">Les √©v√©nements, le secret des op√©rations asynchrones</h2><p>Vous avez d√ª souvent aussi entendre que Javascript √©tait Event Driven et en effet, si vous y regardez de plus pr√®s, l'ex√©cution de code Javascript se fait toujours dans le cadre d'un √©v√©nement envoy√© par le navigateur (load, click, mouseover, progress ...). Ensuite c'est √† vous, d√©veloppeur, de d√©finir ce qu'il va se passer en fonction de ces √©v√©nements.</p><p>Je disais dans la section sur les timers que les timers empilaient des fonctions Javascript, en r√©alit√© c'est le navigateur qui s'occupe de cette t√¢che. Le navigateur va utiliser un timer interne (qui lui est pr√©cis) et enregistrer votre callback sur l'√©v√©nement de fin de timer. Au bout des n que vous aurez d√©finit, il va ajouter dans la pile d'ex√©cution du moteur Javascript la fonction que vous aurez affecter au timer. D√®s que le moteur Javascript sera libre, il s'occupera alors de votre callback.</p><p>Ce sch√©ma se retrouve pour tous les √©v√©nements qui se produisent dans le navigateur. Prenons l'exemple du clic, voici ce qui se passe quand l'utilisateur clique sur un √©l√©ment :</p><ul><li>le navigateur intercepte le clic ;</li><li>il v√©rifie les listeners que vous aurez d√©finis ;</li><li>il les ajoute dans la pile d'ex√©cution de Javascript ;</li><li>quand le moteur est disponible, il ex√©cute chacun des listeners ;</li><li>√† la fin de chaque listener le navigateur joue l'action par d√©faut (par exemple naviguer lors d'un clic sur un lien) si aucun des listeners n'a jou√© preventDefault() sur l'√©v√©nement.</li></ul><p>Toutes les actions asynchrones de Javascript fonctionnent sur ce mod√®le. Par exemple les requ√™tes XMLHttpRequest laissent au navigateur le soin de faire la requ√™te puis de pr√©venir le moteur JS une fois que la requ√™te est finie. Seulement contrairement aux timers, vous ne pourrez jamais pr√©dire quand une requ√™te AJAX sera finie. Par exemple le code suivant :</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'request done'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout ended'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Vous ne pourrez pas dire si votre console va vous afficher &quot;request done&quot; puis &quot;timeout ended&quot; ou le contraire puisque vous n'avez aucune id√©e de quand l'√©v√©nement load sera lanc√©.</p><h2 id="conclusion" tabindex="-1">Conclusion</h2><p>Je pense qu'il est important de bien comprendre le fonctionnement interne des technologies que nous utilisons afin de bien les utiliser. Pour Javascript, S'il y a bien quelque chose √† retenir c'est que Javascript n'√©x√©cute qu'un seul morceau de code √† la fois ! En gardant bien √ßa en t√™te vous verrez que certains comportements que vous ne vous expliquiez pas deviendrons clair.</p><p>Et juste pour voir si vous avez bien compris, que donnera l'ex√©cution de ce bout de code ? (Pas le droit d'utiliser sa console hein ;) )</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
    i<span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">+=</span> <span class="token string">'Batman'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">+=</span> <span class="token string">'nan '</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>NB : Sachez tout de m√™me qu'il existe maintenant les <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Performance/Using_web_workers">web workers</a> qui permettent de cr√©er des threads sur lesquels vous avez la main.</p></div><br><em>You enjoyed this article? Consider <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/intent/tweet?url=https://blog.atomrc.dev/p/javascript-single-threaded-et-asynchrone/&text=Javascript : Single-threaded et asynchrone&via=atomrc">tweeting it</a> :)</em></article><script src="/js/posts.js" async></script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "https://blog.atomrc.dev#website",
      "url": "https://blog.atomrc.dev",
      "name": "Thomas Belin",
      "description": "Freelance Front-End Architect in Paris. I leave code cleaner than I found it. Seriously into Functional and Reactive Programming.",
      "inLanguage": "fr"
    },
    {
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.atomrc.dev/p/javascript-single-threaded-et-asynchrone/"
      },
      "url": "https://blog.atomrc.dev/p/javascript-single-threaded-et-asynchrone/",
      "isPartOf": {
        "@id": "https://blog.atomrc.dev#website"
      },
      "headline": "Javascript : Single-threaded et asynchrone",
      "description": "Comment Javascript fait pour √™tre √† la fois single-threaded et asynchrone.",
      "image": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
      "inLanguage": "fr",
      "publisher": {
        "@type": "Organization",
        "name": "Thomas Belin",
        "url": "https://blog.atomrc.dev#organization",
        "logo": {
          "@type": "ImageObject",
          "url": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
          "width": 300,
          "height": 300
        }
      },
      "author": {
        "@type": "Person",
        "name": "Thomas Belin"
      },
      "keywords": "posts,JavaScript,Internals",
      "datePublished": "2013-06-01T00:00:00.000Z"
    }
  ]
}</script></section><footer>Made with <span class="love">‚ô•</span>Ô∏è by <a href="https://twitter.com/atomrc" rel="noopener noreferrer">@atomrc</a><br><a href="/feed.xml">RSS feed</a></footer></body></html>