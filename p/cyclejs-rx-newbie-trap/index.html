<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="alternate" type="application/rss+xml" title="Thomas Belin's Blog" href="https://blog.atomrc.dev/feed.xml"><link rel="icon" href="/favicon.ico"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><title>Cycle.js, RxJS and cold observables - Thomas Belin</title><meta name="description" content="Lesson learned the hard way: never dive into Cycle.js (+RxJS) without understanding cold/hot observables"><meta name="author" content="Thomas Belin"><link rel="canonical" href="https://blog.atomrc.dev/p/cyclejs-rx-newbie-trap/"><meta name="color-scheme" content="dark light"><style>body{--ff-sans:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Ubuntu","Roboto","Noto Sans","Droid Sans",sans-serif;--ff-mono:ui-monospace,"Cascadia Mono","Segoe UI Mono","Ubuntu Mono","Roboto Mono",Menlo,Monaco,Consolas,monospace;--font-color:#333;--font-secondary-color:#555;--bg-color:#fff;--title-color:#e7005d;--link-color:#0e4db5;--bg-code-color:#f6f6f6;padding:0;margin:0;color:var(--font-color);background-color:var(--bg-color);font-family:var(--ff-sans);font-size:13pt}@media (prefers-color-scheme:dark){body{--font-color:#ddd;--font-secondary-color:#aaa;--bg-color:#1c1c21;--title-color:var(--link-color);--link-color:rgb(88, 166, 255)}}a{text-decoration:none;color:var(--link-color)}ul{list-style:none;padding:0}.avatar{height:100px;width:100px;border-radius:50px}.title{color:var(--title-color)}.tag{font-size:10pt;color:var(--font-secondary-color);font-style:italic}#header{text-align:center;font-size:1.95em;padding:1em}#header .title{color:inherit;font-weight:200}#footer{text-align:center;padding:2em}.love{color:red}#footer a{color:inherit;text-decoration:underline}</style><script async defer="defer" data-domain="atomrc.dev" src="https://plausible.io/js/plausible.js"></script></head><body><div id="header"><div><a href="/"><img class="avatar" src="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=200" alt="Avatar"></a><br><a class="title" href="/"><span rel="author">Thomas Belin</span></a><br></div></div><section><link href="/css/article.css" rel="stylesheet" async defer="defer"><link href="/css/syntax.css" rel="stylesheet" async defer="defer"><style>article{max-width:800px;margin:auto;padding:0 1em;position:relative;line-height:1.5em}article h1{font-size:2em;font-weight:300}article h2,article h3{position:relative;padding-bottom:.3em;font-weight:500}article h2{font-size:2em;border-bottom:solid 1px #eee;margin:1em 0 .5em}article h3{font-size:1.5em;margin:1em 2em}article ul{list-style-type:disc;padding:0 2em}article img{border:solid 1px grey;display:block;max-width:90%;margin:auto}@media (prefers-color-scheme:dark){article h2{border-bottom:solid 1px #333}}</style><article lang="en"><header><h1 class="title">Cycle.js, RxJS and cold observables</h1><aside><time class="folded-paper" datetime="2016-05-05T00:00:00.000Z" pubdate itemprop="datePublished" content="2016-05-05T00:00:00.000Z">05 <span class="month">May</span> 2016</time><br><span class="tag">posts</span>&nbsp; <span class="tag">Cycle.js</span>&nbsp; <span class="tag">RxJS</span>&nbsp;</aside></header><div class="article-body"><p>Lately, I fell into a pretty tough <a href="https://github.com/Reactive-Extensions/RxJS">RxJS</a> beginner trap while playing around with <a href="http://cycle.js.org/">Cycle.js</a>.</p><p>Here is the situation I was in:</p><ul><li>a parent component that creates a child component depending on a data stream;</li><li>a child component that outputs an <code>action$</code> stream that is used in the parent component (depending on DOM events).</li></ul><p>And the symptoms:</p><ul><li>the child component renders perfectly;</li><li>I get the expected output if I subscribe to the <code>action$</code> stream <strong>from inside the child component</strong>;</li><li>the <code>action$</code> stream does not output anything <strong>from the parent component</strong>.</li></ul><p>The reason for that weird behavior: the way <strong>cold observables</strong> work (and, of course, the fact that I didn't took the time to read and understand the RxJS doc ... :( )</p><p>NB: As I am writing this article, Cycle.js is being generalized to work with any stream library (see <a href="https://github.com/cyclejs/core/issues/196">Cycle.js Diversity</a>) and a stream library, specially designed for Cycle.js, is currently being built: <a href="http://staltz.com/why-we-built-xstream.html">xstream</a>. As xtream will be hot-observable-only, this article won't be relevant any more :)</p><h2 id="tldr" tabindex="-1">TLDR</h2><p>Keep in mind that :</p><ul><li>cold observables replay the complete observable chain for each subscriber;</li><li>before diving into Cycle.js be sure you know and understand all the different types of observables;</li><li>just read this <a href="http://reactivex.io/rxjs/manual/overview.html#subject">introduction to observables</a>;</li><li>also, have a look at this great <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">introduction to reactive programming</a></li></ul><h2 id="the-situation" tabindex="-1">The situation</h2><p>Ok let's go a little deeper into my newbie-trap.</p><p>Here is a simplified version of the situation I had.</p><p>The child component:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">UserContainer</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span><span class="token constant">DOM</span><span class="token punctuation">,</span> user$<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> logAction$ <span class="token operator">=</span> <span class="token constant">DOM</span><br>        <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">".log"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">//this prints an output each time the button is clicked</span><br>    logAction$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token comment">/*log*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        <span class="token comment">//the DOM output of the component</span><br>        <span class="token constant">DOM</span><span class="token operator">:</span> user$<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">div</span><span class="token punctuation">(</span><span class="token punctuation">[</span><br>            <span class="token function">span</span><span class="token punctuation">(</span><span class="token string">".user-name"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token function">button</span><span class="token punctuation">(</span><span class="token string">".log"</span><span class="token punctuation">,</span> <span class="token string">"Log"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><br>        <span class="token comment">//the 'log' stream that is used in the parent</span><br>        <span class="token literal-property property">logAction$</span><span class="token operator">:</span> logAction$<br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>The <code>main</code> function that creates the child component:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span><span class="token constant">DOM</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> user$ <span class="token operator">=</span> Observable<span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"felix"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">//we map the user stream to an 'instance' of a UserContainer</span><br>    <span class="token keyword">const</span> userContainer$ <span class="token operator">=</span> user$<br>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span><br>          <span class="token comment">//from @cycle/isolate https://github.com/cyclejs/isolate</span><br>          <span class="token function">isolate</span><span class="token punctuation">(</span>UserContainer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token constant">DOM</span><span class="token punctuation">,</span> <span class="token literal-property property">user$</span><span class="token operator">:</span> Observable<span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br><br>    <span class="token comment">//keep a trace of the DOM evolution for the UserContainer component</span><br>    <span class="token keyword">const</span> userContainerDOM$ <span class="token operator">=</span> userContainer$<br>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">container</span> <span class="token operator">=></span> container<span class="token punctuation">.</span><span class="token constant">DOM</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">//keep a link to the log action of the UserContainer</span><br>    <span class="token keyword">const</span> userContainerLogAction$ <span class="token operator">=</span> userContainer$<br>      <span class="token punctuation">.</span><span class="token function">flatMapLatest</span><span class="token punctuation">(</span><span class="token parameter">container</span> <span class="token operator">=></span> container<span class="token punctuation">.</span>logAction$<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/*<br>     * /!\ here is the problem, this will never print anything<br>     * when the button is clicked !!<br>     */</span><br>    userContainerLogAction$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token comment">/*log*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        <span class="token constant">DOM</span><span class="token operator">:</span> userContainerDOM$<br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>If you want to play with it, here is a <a href="https://jsbin.com/ropaqa/edit?js,console,output">jsbin I created to reproduce the bug</a></p><p>To summary the symptoms I had:</p><ul><li>I had no trouble receiving <code>click</code> events if I subscribe from inside the child component namely <code>UserContainer</code>;</li><li>for some reason I could receive any <code>click</code> events from the function where I build the <code>UserContainer</code> component.</li></ul><h2 id="the-ridiculously-simple-solution" tabindex="-1">The ridiculously simple solution</h2><p>So – without any more suspense – here is the ridiculously simple solution:</p><pre class="language-diff"><code class="language-diff">const userContainer$ = user$<br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> .map(user =><br></span><span class="token prefix unchanged"> </span><span class="token line">     //from @cycle/isolate https://github.com/cyclejs/isolate<br></span><span class="token prefix unchanged"> </span><span class="token line">     isolate(UserContainer)({ DOM, user$: Observable.just(user) })<br></span><span class="token prefix unchanged"> </span><span class="token line"> )<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> .shareReplay(1)</span></span></code></pre><h2 id="explanation" tabindex="-1">Explanation</h2><p>Fixing a bug is a good thing, understanding it is a lot more valuable ;) So here is the explanation for that bug.</p><p>The main reason for that behavior is: the <strong>way cold observable work</strong> in RxJS. In fact a cold observable replays the whole observable sequence for each subscriber it has.</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> values$ <span class="token operator">=</span> Observable<br>    <span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span> <span class="token comment">//this is a cold observable</span><br>    <span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"here I am"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>        <span class="token comment">/* /!\ just for the exemple.<br>         * always avoid doing non deterministic<br>         * calls in your app's code<br>         */</span><br>        Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>value$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"first sub: "</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>value$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"second sub: "</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/* output:<br> * Here I am<br> * first sub: 7<br> * Here I am<br> * second sub: 5<br> */</span></code></pre><p>As you can the, the log <code>Here I am</code> is printed twice and the first subscriber doesn't get the same value as the second subscriber (resp <code>7</code> and <code>5</code>).</p><p>I my case I have that piece of code that is building the <code>UserContainer</code> component:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> userContainer$ <span class="token operator">=</span> user$<br>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span><br>        <span class="token function">isolate</span><span class="token punctuation">(</span>UserContainer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token constant">DOM</span><span class="token punctuation">,</span> <span class="token literal-property property">user$</span><span class="token operator">:</span> Observable<span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span></code></pre><p>And two streams that originate from the <code>userContainer$</code> stream:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> userContainerDOM$ <span class="token operator">=</span> userContainer$<br>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">container</span> <span class="token operator">=></span> container<span class="token punctuation">.</span><span class="token constant">DOM</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> userContainerLogAction$ <span class="token operator">=</span> userContainer$<br>    <span class="token punctuation">.</span><span class="token function">flatMapLatest</span><span class="token punctuation">(</span><span class="token parameter">container</span> <span class="token operator">=></span> container<span class="token punctuation">.</span>logAction$<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>So that means:</p><ul><li>when <code>userContainerDOM$</code> is subscribed it creates a new <code>UserContainer</code> component (from the <code>userContainer$</code>);</li><li>when <code>userContainerLogAction$</code> is subscribed it creates a new <code>UserContainer</code> component (from the <code>userContainer$</code>);</li></ul><p>Which means that each stream has access to a different &quot;instance&quot; of <code>UserContainer</code> and that the log action we retrieve does not come from the same component as the DOM.<br>In other words: we subscribe to events of a component that is not displayed on screen and, as such, does not receive any DOM event**.<br>**this last statement is only true because the UserContainer is isolated (see <a href="https://github.com/cyclejs/isolate">@cycle/isolate</a>)</p><p>Now the <code>shareReplay(1)</code> solution transforms the observable into a <strong>hot observable</strong>. This means the whole subscription sequence will only be executed once per value produced by the stream <code>user$</code>. We also keep the last produced value for further subscriber to get that value when they subscribe.<br>Which means that now, we are only creating a single <code>UserContainer</code> per value produced by the <code>user$</code> stream and that all the underlying subscribers will work on the same &quot;instance&quot; of that <code>UserContainer</code>.</p><h2 id="conclusion" tabindex="-1">Conclusion</h2><p>Cycle.js beginners need to overcome a pretty huge obstacle before embracing the power of Cycle.js: RxJS. Don't get me wrong, RxJS is a great library it's just not perfectly suited for the idea behind Cycle.js.</p><p>There is very little to learn about Cycle.js, it is more of an idea more than a complete library/framework. Once you get the idea behind Cycle.js (which is pretty easy) what you have to learn is <strong>RxJS</strong>. Be sure you know the different operators (at least those inside <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/libraries/lite/rx.lite.md">rx.lite.js</a>) and, most importantly, be sure that you <strong>understand what are observables</strong> by reading this <a href="http://reactivex.io/rxjs/manual/overview.html#subject">introduction to observables</a>.</p><p>One last thing, don't hesitate to ask questions on the <a href="https://gitter.im/cyclejs/core">Cycle.js's gitter chan</a> ;)</p></div><br><em>You enjoyed this article? Consider <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/intent/tweet?url=https://blog.atomrc.dev/p/cyclejs-rx-newbie-trap/&text=Cycle.js, RxJS and cold observables&via=atomrc">tweeting it</a> :)</em></article><script src="/js/application.js" async></script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "https://blog.atomrc.dev#website",
      "url": "https://blog.atomrc.dev",
      "name": "Thomas Belin",
      "description": "Freelance Front-End Architect in Paris. I leave code cleaner than I found it. Seriously into Functional and Reactive Programming.",
      "inLanguage": "en"
    },
    {
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.atomrc.dev/p/cyclejs-rx-newbie-trap/"
      },
      "url": "https://blog.atomrc.dev/p/cyclejs-rx-newbie-trap/",
      "isPartOf": {
        "@id": "https://blog.atomrc.dev#website"
      },
      "headline": "Cycle.js, RxJS and cold observables",
      "description": "Lesson learned the hard way: never dive into Cycle.js (+RxJS) without understanding cold/hot observables",
      "image": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
      "inLanguage": "en",
      "publisher": {
        "@type": "Organization",
        "name": "Thomas Belin",
        "url": "https://blog.atomrc.dev#organization",
        "logo": {
          "@type": "ImageObject",
          "url": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
          "width": 300,
          "height": 300
        }
      },
      "author": {
        "@type": "Person",
        "name": "Thomas Belin"
      },
      "keywords": "posts,Cycle.js,RxJS",
      "datePublished": "2016-05-05T00:00:00.000Z"
    }
  ]
}</script></section><div id="footer">Made with <span class="love">♥</span>️ by <a href="https://twitter.com/atomrc" rel="noopener noreferrer">@atomrc</a></div></body></html>