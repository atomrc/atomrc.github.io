<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="alternate" type="application/rss+xml" title="Thomas Belin's Blog" href="https://blog.atomrc.dev/feed.xml"><link rel="icon" href="/favicon.ico"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><title>Utiliser un repo SSH avec Atlassian Elastic Bamboo - Thomas Belin</title><meta name="description" content="Donner des accès SSH à votre instance EC2 pour Elastic Bamboo"><meta name="author" content="Thomas Belin"><link rel="canonical" href="https://blog.atomrc.dev/p/utiliser-un-repo-en-ssh-avec-elastic-bamboo/"><meta property="og:title" content="Utiliser un repo SSH avec Atlassian Elastic Bamboo - Thomas Belin"><meta property="og:description" content="Donner des accès SSH à votre instance EC2 pour Elastic Bamboo"><meta property="og:url" content="https://blog.atomrc.dev/p/utiliser-un-repo-en-ssh-avec-elastic-bamboo/"><meta property="og:image" content="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@atomrc"><meta name="twitter:title" content="Utiliser un repo SSH avec Atlassian Elastic Bamboo - Thomas Belin"><meta name="twitter:description" content="Donner des accès SSH à votre instance EC2 pour Elastic Bamboo"><meta name="twitter:image" content="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc"><meta name="color-scheme" content="dark light"><style>body{--ff-sans:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Ubuntu","Roboto","Noto Sans","Droid Sans",sans-serif;--ff-mono:ui-monospace,"Cascadia Mono","Segoe UI Mono","Ubuntu Mono","Roboto Mono",Menlo,Monaco,Consolas,monospace;padding:0;margin:0;color:var(--font-color);background-color:var(--bg-color);font-family:var(--ff-sans);font-size:13pt}body,body.light-mode{--font-color:#333;--font-secondary-color:#555;--bg-color:#fff;--title-color:#e7005d;--link-color:#0e4db5;--bg-code-color:#f6f6f6;--secondary-color:#eee}body.dark-mode{--font-color:#ddd;--font-secondary-color:#aaa;--bg-color:#1c1c21;--title-color:var(--link-color);--link-color:rgb(88, 166, 255);--bg-code-color:#444;--secondary-color:#333}#dark-mode-toggle{border:none;background-color:transparent;position:fixed;top:1em;right:1em;z-index:1;height:24px;width:24px;overflow:hidden}#dark-mode-toggle svg{stroke:var(--font-color);fill:var(--font-color);transition:opacity .3s,fill .3s,stroke .3s;position:absolute;top:0;left:0}.dark-mode #dark-mode-toggle .moon,.light-mode #dark-mode-toggle .sun{opacity:0}a{text-decoration:none;color:var(--link-color)}ul{list-style:none;padding:0}.avatar{height:100px;width:100px;border-radius:50px}.title{color:var(--title-color)}.tag{font-size:10pt;color:var(--font-secondary-color);font-style:italic}#header{text-align:center;font-size:1.95em;padding:1em}#header .title{color:var(--font-color);font-weight:200}#footer{text-align:center;padding:2em}.love{color:red}#footer a{color:inherit;text-decoration:underline}.list-container{max-width:50%;margin:auto;text-align:center}@media screen and (max-width:1000px){.list-container{max-width:75%}}@media screen and (max-width:650px){.list-container{max-width:80%}}.list-container__title{text-align:center}.list-container__list li{display:flex;padding-bottom:.5em}.list-container__list time{text-align:right;min-width:90px}.list-container__headline{max-width:500px}.list-container__content{display:inline-block;text-align:left}</style><script async defer="defer" data-domain="atomrc.dev" src="https://plausible.io/js/plausible.js"></script></head><body><button id="dark-mode-toggle" aria-label="Toggle bewteen dark and light mode"><svg xmlns="http://www.w3.org/2000/svg" class="sun" stroke-linejoin="round" stroke-linecap="round" stroke-width="2" stroke="#000" fill="none" height="24" width="24"><circle r="5" cy="12" cx="12"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" class="moon"><path style="stroke-width:.0469517" d="M13.278 24.02c3.707 0 7.093-1.687 9.336-4.451a.564.564 0 0 0-.543-.909c-5.831 1.111-11.186-3.36-11.186-9.247a9.41 9.41 0 0 1 4.765-8.188.564.564 0 0 0-.176-1.044 12.12 12.12 0 0 0-2.196-.2C6.643-.02 1.258 5.356 1.258 12c0 6.635 5.376 12.02 12.02 12.02z"/></svg></button><script>(function (win, doc) {
  let isDarkMode =
    sessionStorage.getItem("darkmode") === undefined
      ? win.matchMedia("(prefers-color-scheme: dark)").matches
      : sessionStorage.getItem("darkmode") === "true";

  const toggleDarkMode = (setDarkMode) => {
    isDarkMode = setDarkMode ?? !isDarkMode;
    sessionStorage.setItem("darkmode", isDarkMode);
    if (isDarkMode) {
      document.body.classList.add("dark-mode");
      document.body.classList.remove("light-mode");
    } else {
      document.body.classList.remove("dark-mode");
      document.body.classList.add("light-mode");
    }
  };

  toggleDarkMode(isDarkMode);
  const darkModeToggle = doc.getElementById("dark-mode-toggle");

  darkModeToggle.addEventListener("click", () => toggleDarkMode());
})(window, document);</script><div id="header"><div><a href="/"><img class="avatar" src="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=200" alt="Avatar"></a><br><a class="title" href="/"><span rel="author">Thomas Belin</span></a><br></div></div><section><link href="/css/article.css" rel="stylesheet" async defer="defer"><link href="/css/syntax.css" rel="stylesheet" async defer="defer"><style>article{max-width:800px;margin:auto;padding:0 1em;position:relative;line-height:1.5em}article h1{font-size:2em;font-weight:300;line-height:1.2em}article h2,article h3{position:relative;padding-bottom:.3em;font-weight:500;line-height:1.2em}article h2{font-size:2em;border-bottom:solid 1px var(--secondary-color);margin:1em 0 .5em}article h3{font-size:1.5em;margin:1em 2em}article ul{list-style-type:disc;padding:0 2em}article picture{border:solid 1px grey;display:block;max-width:100%;margin:auto}picture img,video{width:100%;height:auto}</style><article lang="fr"><header><h1 class="title">Utiliser un repo SSH avec Atlassian Elastic Bamboo</h1><aside><time class="folded-paper" datetime="2014-04-22T00:00:00.000Z" pubdate itemprop="datePublished" content="2014-04-22T00:00:00.000Z">22 <span class="month">Apr</span> 2014</time><br><span class="tag">posts</span>&nbsp; <span class="tag">bamboo</span>&nbsp; <span class="tag">integration continue</span>&nbsp;</aside></header><div class="article-body"><p>Quand vous faites de l'intégration continue avec un repository, vous avez plusieurs possibilités :</p><ul><li>le repo est Open Source et vous n'avez besoin d'aucune autorisation pour le cloner ;</li><li>le repo est privé et vous fournissez un login/mot de passe pour y accéder ;</li><li>le repo est privé vous avez une paire de clés (privée/publique) SSH enregistrées pour votre machine auprès de votre serveur GIT (ou SVN ou que sais-je).</li></ul><p>La solution SSH va s'avérer très pratique lorsque vous utilisez, par exemple, des submodules privés dans votre application.</p><p>Si les deux premières possibilités sont très simples à mettre en place dans Elastic Bamboo, il va falloir ruser un peu pour utiliser la dernière.</p><p>L'idée reste tout de même assez simple : copier les clés SSH (privée et publique) dans le répertoire <code>~/.shh</code> de votre utilisateur Bamboo à chaque lancement de l'instance Amazon EC2.</p><p>Avant tout, je vous invite à aller lire <a href="/p/configuration-amazon-aws-ec2-elastic-bamboo/">mon article sur la configuration d'une instance Amazon EC2 pour Elastic Bamboo</a>.</p><h2 id="g%C3%A9n%C3%A9ration-d'une-paire-de-cl%C3%A9s-pour-votre-image" tabindex="-1">Génération d'une paire de clés pour votre image</h2><p>Bon comme il est toujours bon de le rappeler, voila comment générer une paire de clés SSH. <strong>Attention à ne pas mettre de passphrase à votre clé sinon votre script restera bloqué sur une invite d'input !</strong></p><pre class="language-bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa</code></pre><p>Une fois cette commande exécutée, deux choses à faire :</p><ul><li>ajouter votre clé publique (générée par défaut dans <code>~/.ssh/id_rsa.pub</code>) comme clé autorisée sur votre serveur GIT ;</li><li>garder les contenus de <code>~/.ssh/id_rsa</code>et <code>~/.ssh/id_rsa.pub</code>de côté pour la prochaine étape ;).</li></ul><h2 id="installer-les-cl%C3%A9s-sur-vos-instances-ec2" tabindex="-1">Installer les clés sur vos instances EC2</h2><p>La suite consiste à donner les clés SSH fraichement générées à vos instances Amazon afin de leur donner accès à votre serveur GIT.</p><p>Et pour ça on va utiliser les scripts de démarrage d'une image disponibles dans l'interface d'admin d'Elastic Bamboo.</p><p><img src="//i.imgur.com/SlYZQK2.png" alt="Configuration d'images Elastic Bamboo"></p><p>Une fois dans le formulaire d'édition de l'image que l'on veut utiliser pour les tests, on va remplir le champ 'Instance startup script'. Je vous propose de mettre le script complet ici et j'explique après ;)</p><pre class="language-bash"><code class="language-bash"><span class="token function">rm</span> <span class="token parameter variable">-rf</span> /home/bamboo/.ssh <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null<br><span class="token function">mkdir</span> /home/bamboo/.ssh<br> <br><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /home/bamboo/.ssh/config</span><br>Host bitbucket.org<br>StrictHostKeyChecking no<br>UserKnownHostsFile /dev/null<br>EOF</span><br><br><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /home/bamboo/.ssh/id_rsa.pub</span><br>ssh-rsa &lt;The public key here> BambooElaticInstance<br>EOF</span><br> <br><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /home/bamboo/.ssh/id_rsa</span><br>-----BEGIN RSA PRIVATE KEY-----<br>&lt;The private key here><br>-----END RSA PRIVATE KEY-----<br>EOF</span><br><br><span class="token function">chown</span> bamboo <span class="token parameter variable">-R</span> /home/bamboo/.ssh<br><br><span class="token function">chmod</span> <span class="token number">600</span> /home/bamboo/.ssh/id_rsa<br><span class="token function">chmod</span> <span class="token number">600</span> /home/bamboo/.ssh/config</code></pre><p>A savoir sur les script de démarrage d'instance :</p><ul><li>ils sont lancés à chaque lancement d'une machine Amazon ;</li><li>ils sont exécutés en tant que <code>root</code> user de la machine (vous avez donc tous les droits) ;</li><li>ils sont lancés avant le lancement des agents Bamboo.</li></ul><p>Bon décomposons le script que je vous ai donné plus haut : On commence par supprimer un éventuel précédent répertoire <code>.ssh</code>. On envoie la sortie d'erreur sur <code>/dev/null</code> pour ne pas faire planter le script si le répertoire n'existe pas :</p><pre class="language-bash"><code class="language-bash"><span class="token function">rm</span> <span class="token parameter variable">-rf</span> /home/bamboo/.ssh <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null</code></pre><p>On configure SSH pour ne pas qu'il demande confirmation avant d'ajouter un serveur qu'il n'a jamais utilisé. Il faudra donc remplacer <code>bitbucket.org</code> par le nom du serveur que vous utilisez. Cette commande permet de ne pas bloquer le script sur une attente d'input utilisateur :</p><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /home/bamboo/.ssh/config</span><br>Host bitbucket.org<br>StrictHostKeyChecking no<br>UserKnownHostsFile /dev/null<br>EOF</span></code></pre><p>On copie le contenu de la clé publique générée à la première étape dans le répertoire qui va bien sur notre instance :</p><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /home/bamboo/.ssh/id_rsa.pub</span><br>ssh-rsa &lt;The public key here> BambooElaticInstance<br>EOF</span></code></pre><p>Même chose pour la clé privée :</p><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /home/bamboo/.ssh/id_rsa</span><br>-----BEGIN RSA PRIVATE KEY-----<br>&lt;The private key here><br>-----END RSA PRIVATE KEY-----<br>EOF</span></code></pre><p>Jusque là, on travaillait avec l'utilisateur <code>root</code>, on donne donc le répertoire <code>.ssh</code> et son contenu à l'utilisateur <code>bamboo</code> :</p><pre class="language-bash"><code class="language-bash"><span class="token function">chown</span> bamboo <span class="token parameter variable">-R</span> /home/bamboo/.ssh</code></pre><p>Enfin on protège les clés générée sans quoi SSH refusera de fonctionner :</p><pre class="language-bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">600</span> /home/bamboo/.ssh/id_rsa<br><span class="token function">chmod</span> <span class="token number">600</span> /home/bamboo/.ssh/config</code></pre><p>Une fois toutes ces étapes faites vous pourrez démarrer une nouvelle instance à partir de votre image fraichement configurée et faire le test ultime à partir de cette dernière :</p><pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone git@bitbucket.com:username/yourrepo.git</code></pre><p>Si ça marche, c'est que vous êtes bon pour passer à l'étape de tests de votre application (des <a href="/p/lancer-des-tests-atoum-dans-bamboo/">tests Atoum par exemple</a> ;) ).</p></div><br><em>You enjoyed this article? Consider <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/intent/tweet?url=https://blog.atomrc.dev/p/utiliser-un-repo-en-ssh-avec-elastic-bamboo/&text=Utiliser un repo SSH avec Atlassian Elastic Bamboo&via=atomrc">tweeting it</a> :)</em></article><script src="/js/posts.js" async></script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "https://blog.atomrc.dev#website",
      "url": "https://blog.atomrc.dev",
      "name": "Thomas Belin",
      "description": "Freelance Front-End Architect in Paris. I leave code cleaner than I found it. Seriously into Functional and Reactive Programming.",
      "inLanguage": "fr"
    },
    {
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.atomrc.dev/p/utiliser-un-repo-en-ssh-avec-elastic-bamboo/"
      },
      "url": "https://blog.atomrc.dev/p/utiliser-un-repo-en-ssh-avec-elastic-bamboo/",
      "isPartOf": {
        "@id": "https://blog.atomrc.dev#website"
      },
      "headline": "Utiliser un repo SSH avec Atlassian Elastic Bamboo",
      "description": "Donner des accès SSH à votre instance EC2 pour Elastic Bamboo",
      "image": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
      "inLanguage": "fr",
      "publisher": {
        "@type": "Organization",
        "name": "Thomas Belin",
        "url": "https://blog.atomrc.dev#organization",
        "logo": {
          "@type": "ImageObject",
          "url": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
          "width": 300,
          "height": 300
        }
      },
      "author": {
        "@type": "Person",
        "name": "Thomas Belin"
      },
      "keywords": "posts,bamboo,integration continue",
      "datePublished": "2014-04-22T00:00:00.000Z"
    }
  ]
}</script></section><div id="footer">Made with <span class="love">♥</span>️ by <a href="https://twitter.com/atomrc" rel="noopener noreferrer">@atomrc</a></div></body></html>