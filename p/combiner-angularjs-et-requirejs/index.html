<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="alternate" type="application/rss+xml" title="Thomas Belin's Blog" href="https://blog.atomrc.dev/feed.xml"><link rel="icon" href="/favicon.ico"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><title>Chargement asynchrone d'AngularJS avec RequireJS - Thomas Belin</title><meta name="description" content="Utiliser AngularJS comme un module AMD avec RequireJS"><meta name="author" content="Thomas Belin"><link rel="canonical" href="https://blog.atomrc.dev/p/combiner-angularjs-et-requirejs/"><meta name="color-scheme" content="dark light"><style>body{--ff-sans:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Ubuntu","Roboto","Noto Sans","Droid Sans",sans-serif;--ff-mono:ui-monospace,"Cascadia Mono","Segoe UI Mono","Ubuntu Mono","Roboto Mono",Menlo,Monaco,Consolas,monospace;padding:0;margin:0;color:var(--font-color);background-color:var(--bg-color);font-family:var(--ff-sans);font-size:13pt}body,body.light-mode{--font-color:#333;--font-secondary-color:#555;--bg-color:#fff;--title-color:#e7005d;--link-color:#0e4db5;--bg-code-color:#f6f6f6;--secondary-color:#eee}body.dark-mode{--font-color:#ddd;--font-secondary-color:#aaa;--bg-color:#1c1c21;--title-color:var(--link-color);--link-color:rgb(88, 166, 255);--bg-code-color:#444;--secondary-color:#333}#dark-mode-toggle{border:none;background-color:transparent;position:fixed;top:1em;right:1em;z-index:1;height:24px;width:24px;overflow:hidden}#dark-mode-toggle svg{stroke:var(--font-color);fill:var(--font-color);transition:opacity .3s,fill .3s,stroke .3s;position:absolute;top:0;left:0}.dark-mode #dark-mode-toggle .moon,.light-mode #dark-mode-toggle .sun{opacity:0}a{text-decoration:none;color:var(--link-color)}ul{list-style:none;padding:0}.avatar{height:100px;width:100px;border-radius:50px}.title{color:var(--title-color)}.tag{font-size:10pt;color:var(--font-secondary-color);font-style:italic}#header{text-align:center;font-size:1.95em;padding:1em}#header .title{color:var(--font-color);font-weight:200}#footer{text-align:center;padding:2em}.love{color:red}#footer a{color:inherit;text-decoration:underline}</style><script async defer="defer" data-domain="atomrc.dev" src="https://plausible.io/js/plausible.js"></script></head><body><button id="dark-mode-toggle" aria-label="Toggle bewteen dark and light mode"><svg xmlns="http://www.w3.org/2000/svg" class="sun" stroke-linejoin="round" stroke-linecap="round" stroke-width="2" stroke="#000" fill="none" height="24" width="24"><circle r="5" cy="12" cx="12"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" class="moon"><path style="stroke-width:.0469517" d="M13.278 24.02c3.707 0 7.093-1.687 9.336-4.451a.564.564 0 0 0-.543-.909c-5.831 1.111-11.186-3.36-11.186-9.247a9.41 9.41 0 0 1 4.765-8.188.564.564 0 0 0-.176-1.044 12.12 12.12 0 0 0-2.196-.2C6.643-.02 1.258 5.356 1.258 12c0 6.635 5.376 12.02 12.02 12.02z"/></svg></button><script>(function (win, doc) {
  let isDarkMode =
    sessionStorage.getItem("darkmode") === undefined
      ? win.matchMedia("(prefers-color-scheme: dark)").matches
      : sessionStorage.getItem("darkmode") === "true";

  const toggleDarkMode = (setDarkMode) => {
    isDarkMode = setDarkMode ?? !isDarkMode;
    sessionStorage.setItem("darkmode", isDarkMode);
    if (isDarkMode) {
      document.body.classList.add("dark-mode");
      document.body.classList.remove("light-mode");
    } else {
      document.body.classList.remove("dark-mode");
      document.body.classList.add("light-mode");
    }
  };

  toggleDarkMode(isDarkMode);
  const darkModeToggle = doc.getElementById("dark-mode-toggle");

  darkModeToggle.addEventListener("click", () => toggleDarkMode());
})(window, document);</script><div id="header"><div><a href="/"><img class="avatar" src="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=200" alt="Avatar"></a><br><a class="title" href="/"><span rel="author">Thomas Belin</span></a><br></div></div><section><link href="/css/article.css" rel="stylesheet" async defer="defer"><link href="/css/syntax.css" rel="stylesheet" async defer="defer"><style>article{max-width:800px;margin:auto;padding:0 1em;position:relative;line-height:1.5em}article h1{font-size:2em;font-weight:300;line-height:1.2em}article h2,article h3{position:relative;padding-bottom:.3em;font-weight:500;line-height:1.2em}article h2{font-size:2em;border-bottom:solid 1px var(--secondary-color);margin:1em 0 .5em}article h3{font-size:1.5em;margin:1em 2em}article ul{list-style-type:disc;padding:0 2em}article picture{border:solid 1px grey;display:block;max-width:100%;margin:auto}picture img,video{width:100%;height:auto}</style><article lang="fr"><header><h1 class="title">Chargement asynchrone d'AngularJS avec RequireJS</h1><aside><time class="folded-paper" datetime="2013-03-10T00:00:00.000Z" pubdate itemprop="datePublished" content="2013-03-10T00:00:00.000Z">10 <span class="month">Mar</span> 2013</time><br><span class="tag">posts</span>&nbsp; <span class="tag">angularjs</span>&nbsp; <span class="tag">requirejs</span>&nbsp; <span class="tag">amd</span>&nbsp;</aside></header><div class="article-body"><p>Lorsque j'ai commencé à utilisé <a href="http://angularjs.org/">AngularJS</a> pour faire le blog que vous lisez actuellement, j'étais plus que convaincu par les avantages de <a href="http://requirejs.org/">RequireJS</a>. Maintenant je ne peux plus m'en passer et mon premier réflexe quand je commence un projet Javascript est d'importer RequireJS. Seulement, AngularJS n'étant pas défini comme un module et disposant d'un système propre pour définir des modules, j'avais peur de me trouver face à des conflits entre les deux systèmes ou de ne carrément pas réussir à charger AngularJS via RequireJS. Heureusement RequireJS a tout prévu et l'intégration des deux s'est finalement passé sans problème grâce à deux astuces de RequireJS : shim et deps</p><h2 id="pourquoi-requirejs-%3F" tabindex="-1">Pourquoi RequireJS ?</h2><p>Je ne ferai pas ici une présentation complète de RequireJS, mais simplement vous donner les éléments qui m'ont poussés à l'utiliser sur ce projet. La question cachée est surtout : pourquoi utiliser un système de modules au dessus de celui d'AngularJS ? En réalité les deux systèmes n'ont pas vraiment le même objectif. AngularJS va simplement vous permettre de ne pas polluer l'objet <code>window</code> et de garder votre code dans le &quot;namespace&quot; d'Angular. En revanche Angular ne va pas du tout gérer toutes les bibliothèques externes que vous chargez ou encore le chargement des fichiers source. Les bénéfices de RequireJS seront les suivants :</p><ul><li>la modularisation des bibliothèques externes en plus de votre propre code ;</li><li>le chargement des fichiers source de façon asynchrone et en fonction des besoins ;</li><li>l'objet window ne sera quasiment pas sollicité ni pollué ;</li><li>vous n'aurez pas à inclure vos fichiers source dans le layout de votre page, RequireJS va s'occuper de résoudre les dépendances et charger les fichiers correspondants ;</li><li>la minification de vos sources en fonction de vos modules.</li></ul><h2 id="a-quoi-je-veux-arriver" tabindex="-1">A quoi je veux arriver</h2><p>Ce que je veux c'est que la seule et unique balise script qui soit dans mon code HTML soit la balise qui inclut RequireJS.</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/lib/require.min.js<span class="token punctuation">"</span></span> <span class="token attr-name">data-main</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/main.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>Si j'ai une seule autre balise <code>&lt;script&gt;</code> dans mon code HTML ... J'ai perdu !!</p><h2 id="chargement-d'angularjs-via-requirejs" tabindex="-1">Chargement d'AngularJS via RequireJS</h2><p>Le premier problème que vous devriez rencontrer est le chargement d'AngularJS avec RequireJS. Il y a deux petits problèmes liés à ce chargement : AngularJS n'est pas défini comme un module et l'initialisation d'Angular ne se lance pas quand il est chargé comme module. Ne vous en faites pas la résolution de ces problèmes est très simple. AngularJS n'est pas un module</p><p>La première chose est que Angular n'est pas <a href="http://dailyjs.com/2011/12/22/framework/">AMD compliant</a> (cad. il n'est pas prévu pour être chargé de façon modulaire mais pour être ajouté à l'objet window). Beaucoup de bibliothèques ne sont pas encore &quot;AMD compliant&quot; et, aucun problème, RequireJS gère ça à la perfection grâce aux configurations shim. Notre configuration va donc être la suivante :</p><pre class="language-javascript"><code class="language-javascript">requirejs<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token literal-property property">paths</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>	<span class="token comment">//path to angularJS file</span><br>        <span class="token literal-property property">angular</span><span class="token operator">:</span> <span class="token string">'../lib/angular.min'</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>    <span class="token literal-property property">shim</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token literal-property property">angular</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>            <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> angular<span class="token punctuation">;</span> <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Avec ces lignes, on dit à RequireJS où est le fichier d'Angular et que quand on fait appel à Angular, il doit nous renvoyer l'objet angular présent dans l'objet window. Ainsi Angular sera tout de même ajouté à window mais sera utilisé comme un module dans votre code. Autrement dit on accédera jamais à l'objet window.angular directement.</p><h2 id="lancer-manuellement-l'initialisation-d'angularjs" tabindex="-1">Lancer manuellement l'initialisation d'AngularJS</h2><p>Pour bien comprendre ce problème, ayez en tête que RequireJS charge tous les fichiers source de façon asynchrone. Ce qui veut dire que le callback window.onload pourra être appelé avant même que le client ai chargé le premier fichier source. Or AngularJS se sert de cet événement pour lancer son initialisation mais étant chargé après, il ne la lance jamais. Vous devez donc la lancer vous même. Rien de bien compliqué ici :</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment">//load the angular library before doing anything</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'angular'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br><br>    <span class="token comment">//callback called when angular is loaded </span><br>    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">Angular</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token comment">//init angular for the module 'blog'</span><br>    Angular<span class="token punctuation">.</span><span class="token function">bootstrap</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>document<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'blog'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2 id="les-modules-compl%C3%A9mentaires-d'angular" tabindex="-1">Les modules complémentaires d'Angular</h2><p>Dans votre projet vous aurez peut-être besoin de <a href="http://code.angularjs.org/1.0.5/">modules complémentaires</a> pour AngularJS. Dans le cas de mon blog, j'ai eu besoin de ngResource pour interagir avec mon API RESTfull et de ngSanitize. Pour être chargés correctement, ces modules ont besoin que Angular soit définit dans l'objet window. Or RequireJS charge les fichiers de façon asynchrone et vous ne pouvez pas dire si Angular sera bien chargé avant ses modules. Une fois de plus RequireJS a tout prévu et permet d'indiquer que des modules sont dépendants d'autres. Notre configuration va donc donner ça :</p><pre class="language-javascript"><code class="language-javascript">requirejs<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token literal-property property">paths</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>	<span class="token comment">//path to angularJS file</span><br>        <span class="token literal-property property">angular</span><span class="token operator">:</span> <span class="token string">'../lib/angular.min'</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">ngSanitize</span><span class="token operator">:</span> <span class="token string">'../lib/angular.sanitize.min'</span><span class="token punctuation">,</span><br>        <span class="token literal-property property">ngResource</span><span class="token operator">:</span> <span class="token string">'../lib/angular.resource.min'</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>    <span class="token literal-property property">shim</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token literal-property property">angular</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>            <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> angular<span class="token punctuation">;</span> <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>        <span class="token literal-property property">ngSanitize</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>            <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token string">'ngSanitize'</span><span class="token punctuation">,</span><br>	    <span class="token comment">//dependancies for the ngSanitize module</span><br>            <span class="token literal-property property">deps</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'angular'</span><span class="token punctuation">]</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br><br>        <span class="token literal-property property">ngResource</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>            <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token string">'ngResource'</span><span class="token punctuation">,</span><br>	    <span class="token comment">//dependancies for the ngResource module</span><br>            <span class="token literal-property property">deps</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'angular'</span><span class="token punctuation">]</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Ainsi lorsque l'on va demander à RequireJS le module ngSanitize, RequireJS va d'abord vérifier si angular est chargé et le charger si jamais ce n'était pas le cas. En bref</p><p>Après avoir passé ces petits obstacles que RequireJS gère à merveille, il ne vous reste plus qu'a vous lancer pleinement dans le développement de votre application AngularJS en gardant toujours à l'esprit de ne jamais ajouter une nouvelle balise <code>&lt;script&gt;</code> dans votre code HTML ;)</p></div><br><em>You enjoyed this article? Consider <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/intent/tweet?url=https://blog.atomrc.dev/p/combiner-angularjs-et-requirejs/&text=Chargement asynchrone d'AngularJS avec RequireJS&via=atomrc">tweeting it</a> :)</em></article><script src="/js/posts.js" async></script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "https://blog.atomrc.dev#website",
      "url": "https://blog.atomrc.dev",
      "name": "Thomas Belin",
      "description": "Freelance Front-End Architect in Paris. I leave code cleaner than I found it. Seriously into Functional and Reactive Programming.",
      "inLanguage": "fr"
    },
    {
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.atomrc.dev/p/combiner-angularjs-et-requirejs/"
      },
      "url": "https://blog.atomrc.dev/p/combiner-angularjs-et-requirejs/",
      "isPartOf": {
        "@id": "https://blog.atomrc.dev#website"
      },
      "headline": "Chargement asynchrone d'AngularJS avec RequireJS",
      "description": "Utiliser AngularJS comme un module AMD avec RequireJS",
      "image": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
      "inLanguage": "fr",
      "publisher": {
        "@type": "Organization",
        "name": "Thomas Belin",
        "url": "https://blog.atomrc.dev#organization",
        "logo": {
          "@type": "ImageObject",
          "url": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
          "width": 300,
          "height": 300
        }
      },
      "author": {
        "@type": "Person",
        "name": "Thomas Belin"
      },
      "keywords": "posts,angularjs,requirejs,amd",
      "datePublished": "2013-03-10T00:00:00.000Z"
    }
  ]
}</script></section><div id="footer">Made with <span class="love">♥</span>️ by <a href="https://twitter.com/atomrc" rel="noopener noreferrer">@atomrc</a></div></body></html>