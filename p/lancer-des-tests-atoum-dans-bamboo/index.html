<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="alternate" type="application/rss+xml" title="Thomas Belin's Blog" href="https://blog.atomrc.dev/feed.xml"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><title>Bamboo et les tests Atoum - Thomas Belin</title><meta name="description" content="Senior Front-End Architect @deezer in Paris. I leave code cleaner than I found it. Seriously into Functional and Reactive Programming."><meta name="robots" content="index,follow"><meta name="author" content="Thomas Belin"><link rel="canonical" href="https://blog.atomrc.dev/p/lancer-des-tests-atoum-dans-bamboo/"><meta property="og:title" content="Bamboo et les tests Atoum - Thomas Belin"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.atomrc.dev/p/lancer-des-tests-atoum-dans-bamboo/"><meta property="og:description" content="Senior Front-End Architect @deezer in Paris. I leave code cleaner than I found it. Seriously into Functional and Reactive Programming."><meta property="og:image" content="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@atomrc"><meta name="twitter:url" content="https://blog.atomrc.dev/p/lancer-des-tests-atoum-dans-bamboo/"><meta name="twitter:title" content="Bamboo et les tests Atoum - Thomas Belin"><meta name="twitter:description" content="Senior Front-End Architect @deezer in Paris. I leave code cleaner than I found it. Seriously into Functional and Reactive Programming."><meta name="twitter:image" content="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300"><meta name="theme-color" content="#ffffff"><style>body{--ff-sans:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Ubuntu","Roboto","Noto Sans","Droid Sans",sans-serif;--ff-mono:ui-monospace,"Cascadia Mono","Segoe UI Mono","Ubuntu Mono","Roboto Mono",Menlo,Monaco,Consolas,monospace;padding:0;margin:0;color:#333;background-color:#fff;font-family:var(--ff-sans);font-size:13pt}a{text-decoration:none;color:#0e4db5}ul{list-style:none;padding:0}.avatar{height:100px;width:100px;border-radius:50px}.title{color:#e7005d}.tag{font-size:10pt;color:#888;font-style:italic}#header{text-align:center;font-size:1.95em;padding:1em}#header .title{text-shadow:1px 1px 0 #fff;color:inherit;font-weight:200}#footer{background-color:#5986d1;color:#fff;text-align:center;padding:1em}#footer a{color:#010733}</style><script async defer="defer" data-domain="atomrc.dev" src="https://plausible.io/js/plausible.js"></script></head><body><div id="header"><div><a href="/"><img class="avatar" src="https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=200" alt="Avatar"></a><br><a class="title" href="/"><span rel="author">Thomas Belin</span></a><br></div></div><section><link href="/css/article.css" rel="stylesheet" async defer="defer"><link href="/css/syntax.css" rel="stylesheet" async defer="defer"><style>article{max-width:800px;margin:auto;padding:0 1em;position:relative}article h1{font-size:2em;font-weight:300}article h2,article h3{position:relative;padding-bottom:.3em;font-weight:500}article h2{font-size:2em;border-bottom:solid 1px #eee;margin:1em 0 .5em}article h3{font-size:1.5em;margin:1em 2em}article p{line-height:1.6em}article img{border:solid 1px grey;display:block;max-width:90%;margin:auto}</style><article lang="fr"><header><h1 class="title">Bamboo et les tests Atoum</h1><aside><time class="folded-paper" datetime="Wed Apr 16 2014 00:00:00 GMT+0000 (Coordinated Universal Time)" pubdate itemprop="datePublished" content="Wed Apr 16 2014 00:00:00 GMT+0000 (Coordinated Universal Time)">16 <span class="month">Apr</span> 2014</time><br><span class="tag">posts</span>&nbsp; <span class="tag">php</span>&nbsp; <span class="tag">atoum</span>&nbsp; <span class="tag">bamboo</span>&nbsp; <span class="tag">integration continue</span>&nbsp;</aside></header><div class="article-body"><p>Chez <a href="http://www.doyoubuzz.com">DoYouBuzz</a> nous utilisons <a href="http://docs.atoum.org/fr/">Atoum</a> pour tous nos tests unitaires PHP. Je pense qu'il n'est pas nécessaire de vous rappeler l'interêts des tests unitaires.</p><p>Ecrire des tests c'est très bien, mais les jouer régulièrement, c'est mieux :) C'est pourquoi, nous avons mis en place un <a href="/p/integration-continue-avec-bamboo/">serveur d'intégration continue chez DoYouBuzz</a>.</p><p>Comme Bamboo semble plutôt avoir été pensé pour le monde Java, le seul wrapper de tests disponible pour PHP est PHPUnit. Il va donc nous falloir faire notre propre script de lancement de tests Atoum.</p><h2 id="tldr">TLDR</h2><p>Le script à exécuter pour lancer les tests Atoum dans Bamboo :</p><pre class="language-bash"><code class="language-bash">php  bin/atoum -c path/to/config.php -d path/to/tests/units <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null<span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span></code></pre><p>La config d'Atoum pour générer un rapport au format xUnit :</p><pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br> <br><span class="token comment">//...</span><br> <br><span class="token comment">/*<br> * Xunit report<br> */</span><br><span class="token variable">$xunit</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">atoum<span class="token punctuation">\</span>reports<span class="token punctuation">\</span>asynchronous<span class="token punctuation">\</span>xunit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token variable">$runner</span><span class="token operator">-></span><span class="token function">addReport</span><span class="token punctuation">(</span><span class="token variable">$xunit</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br> <br><span class="token comment">/*<br> * Xunit writer<br> */</span><br><span class="token variable">$writer</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">atoum<span class="token punctuation">\</span>writers<span class="token punctuation">\</span>file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/chemin/vers/le/rapport/atoum.xunit.xml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token variable">$xunit</span><span class="token operator">-></span><span class="token function">addWriter</span><span class="token punctuation">(</span><span class="token variable">$writer</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><h2 id="exc%C3%A9cution-des-tests-atoum">Excécution des tests Atoum</h2><p>Pour ça, on va configurer notre projet Bamboo pour lui ajouter un nouveau &quot;Stage&quot;. (pour bien comprendre les différences entre &quot;Project&quot;, &quot;Plan&quot;, &quot;Stage&quot;, &quot;Job&quot; et &quot;Task&quot; je vous laisse lire la <a href="https://confluence.atlassian.com/display/BAMBOO/Configuring+plans">documentation de Bamboo sur le sujet</a>).</p><p>C'est ensuite dans un Job qu'on va lancer les tests. Pour ça, on ajoute à notre Job une nouvelle Task de type &quot;script&quot; que l'on peut appeler &quot;Atoum tests&quot; par exemple.</p><p><img src="//i.imgur.com/ZTJmWyA.png" alt="add-script-task"></p><p>Voila le contenu du script en question :</p><pre class="language-bash"><code class="language-bash">php  bin/atoum -c path/to/config.php -d path/to/tests/units <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null<span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span></code></pre><p>(protip : vous pouvez aussi ajouter un fichier script dans le repository de votre projet et donner à Bamboo le chemin vers le fichier à jouer.)</p><p>Je pense que la première partie du script est facilement compréhensible, c'est tout bonnement le lancement des tests. La seconde partie du script (<code>2&gt; /dev/null; exit 0;</code>) est là pour que, quelque soit le résultats des tests, le script ne renvoie pas de code d'erreur. Pour ça, on redirige la sortie d'erreur sur <code>/dev/null</code> puis on indique que l’exécution du script a été un succès (<code>exit 0;</code>).</p><p>En réalité, quand vous ajouter un script comme &quot;Task&quot; de Bamboo, Bamboo s'attend à recevoir un code de succès après ’exécution du script. Dans le cas contraire, le build s'arrête et est considéré comme un &quot;fail&quot;. Aucune des &quot;Task&quot; qui suivent ne seront jouées. Aussi si vos tests échouent, ce que vous aurez prévu ensuite ne sera pas joué et vous n'aurez pas non plus le bénéfice du rapport d'erreur Atoum.</p><h2 id="g%C3%A9n%C3%A9ration-et-interpr%C3%A9tation-du-rapport-de-test">Génération et interprétation du rapport de test</h2><p>Bamboo vous permet d'ajouter un ou plusieurs rapports de tests qui seront interprétés pendant un &quot;Job&quot;.</p><p>Pour générer un rapport au format xUnit avec Atoum, il vous suffit d'ajouter ces lignes dans votre fichier de configuration (code issu de la <a href="http://docs.atoum.org/fr/chapitre4.html#Etape-1-Ajout-d-un-rapport-xUnit-a-la-configuration-atoum">documentation Atoum</a>)</p><pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br> <br><span class="token comment">//...</span><br> <br><span class="token comment">/*<br> * Xunit report<br> */</span><br><span class="token variable">$xunit</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">atoum<span class="token punctuation">\</span>reports<span class="token punctuation">\</span>asynchronous<span class="token punctuation">\</span>xunit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token variable">$runner</span><span class="token operator">-></span><span class="token function">addReport</span><span class="token punctuation">(</span><span class="token variable">$xunit</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br> <br><span class="token comment">/*<br> * Xunit writer<br> */</span><br><span class="token variable">$writer</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">atoum<span class="token punctuation">\</span>writers<span class="token punctuation">\</span>file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/chemin/vers/le/rapport/atoum.xunit.xml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token variable">$xunit</span><span class="token operator">-></span><span class="token function">addWriter</span><span class="token punctuation">(</span><span class="token variable">$writer</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Ensuite, dans Bamboo, on va rajouter un parser pour le rapport qui sera généré à chaque exécution des tests Atoum. On va donc ajouter une nouvelle &quot;Task&quot; de type &quot;JUnit Parser&quot; :</p><p><img src="//i.imgur.com/IdR8Ieq.png" alt="JUnit parser Bamboo"></p><p>Le plus simple est de faire un répertoire dans lequel on va mettre tous les rapports de tests de tous nos différents frameworks de test pour que Bamboo les interprètes tous d'un coup. On va donc mettre, dans le champ &quot;Specify custom results directories&quot; <code>/chemin/vers/le/rapport/*.xunit.xml</code></p><p>Ainsi tous les rapports de tests avec l'extension <code>.xunit.xml</code> qui seront ajoutés au répertoire <code>/chemin/vers/le/rapport</code> seront interprétés par Bamboo.</p><h2 id="pour-aller-plus-loin">Pour aller plus loin</h2><p>Vous pouvez demander à Atoum de générer un rapport de couverture de code à la fin de vos tests. Bamboo est tout à fait capable d'interpréter ce rapport. malheureusement, je n'ai pas vraiment pu explorer cette piste à fond puisque une fois l'extension php <code>xdebug</code> installée sur notre serveur, les tests utilisent trop de mémoire sur notre instance micro Amazon qui bloque le build en cours côté Bamboo.</p></div><br><em>You enjoyed this article? Consider <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/intent/tweet?url=https://blog.atomrc.dev/p/lancer-des-tests-atoum-dans-bamboo/&text=Bamboo et les tests Atoum&via=atomrc">tweeting it</a> :)</em></article><script src="/js/application.js" async></script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "https://blog.atomrc.dev#website",
      "url": "https://blog.atomrc.dev",
      "name": "Thomas Belin",
      "description": "Senior Front-End Architect @deezer in Paris. I leave code cleaner than I found it. Seriously into Functional and Reactive Programming.",
      "inLanguage": "fr"
    },
    {
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.atomrc.dev/p/lancer-des-tests-atoum-dans-bamboo/"
      },
      "url": "https://blog.atomrc.dev/p/lancer-des-tests-atoum-dans-bamboo/",
      "isPartOf": {
        "@id": "https://blog.atomrc.dev#website"
      },
      "headline": "Bamboo et les tests Atoum",
      "description": "Configurer votre serveur Bamboo pour jouer et interpréter vos tests Atoum",
      "image": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
      "inLanguage": "fr",
      "publisher": {
        "@type": "Organization",
        "name": "Thomas Belin",
        "url": "https://blog.atomrc.dev",
        "logo": {
          "@type": "ImageObject",
          "url": "https://www.gravatar.com/avatar/56f2389bd912f388cc79874ce65fc0dc?s=300",
          "width": 300,
          "height": 300
        }
      },
      "author": {
        "@type": "Person",
        "name": "Thomas Belin"
      },
      "keywords": "posts,php,atoum,bamboo,integration continue",
      "datePublished": "2014-04-16T00:00:00.000Z"
    }
  ]
}</script></section><div id="footer"><address>Senior Front-End Engineer <a href="https://deezer.com" target="_blank" rel="noreferrer noopener">@deezer</a> in Paris.<br>I leave code cleaner than I found it.<br>I tweet (<a href="https://twitter.com/atomrc" target="_blank" rel="noreferrer noopener">@atomrc</a>) and I code (<a href="https://github.com/atomrc" target="_blank" rel="noreferrer noopener">atomrc</a>)<br>I help (<a href="https://stackoverflow.com/users/2745879/atomrc" target="_blank" rel="noreferrer noopener">S.O profile</a>)</address></div></body></html>